{"version":3,"file":"jsdom-inline-worker.umd.js","sources":["../src/index.js"],"sourcesContent":["import mitt from 'mitt';\nimport uuid from 'uuid-v4';\nimport fetch, { Response } from 'node-fetch';\n\nif (!global.URL) global.URL = {};\nif (!global.URL.$$objects) {\n\tglobal.URL.$$objects = new Map();\n\tglobal.URL.createObjectURL = blob => {\n\t\tlet id = uuid();\n\t\tglobal.URL.$$objects[id] = blob;\n\t\treturn `blob:http://localhost/${id}`;\n\t};\n\n\tlet oldFetch = global.fetch || fetch;\n\tglobal.fetch = function(url, opts) {\n\t\tif (url.match(/^blob:/)) {\n\t\t\treturn new Promise( (resolve, reject) => {\n\t\t\t\tlet fr = new FileReader();\n\t\t\t\tfr.onload = () => {\n\t\t\t\t\tlet Res = global.Response || Response;\n\t\t\t\t\tresolve(new Res(fr.result, { status: 200, statusText: 'OK' }));\n\t\t\t\t};\n\t\t\t\tfr.onerror = () => {\n\t\t\t\t\treject(fr.error);\n\t\t\t\t};\n\t\t\t\tlet id = url.match(/[^/]+$/)[0];\n\t\t\t\tfr.readAsText(global.URL.$$objects[id]);\n\t\t\t});\n\t\t}\n\t\treturn oldFetch.call(this, url, opts);\n\t};\n}\n\nif (!global.document) {\n\tglobal.document = {};\n}\n\nfunction Event(type) { this.type = type; }\nif (!global.document.createEvent) {\n\tglobal.document.createEvent = function(type) {\n\t\tlet Ctor = global[type] || Event;\n\t\treturn new Ctor(type);\n\t};\n}\n\n\nglobal.Worker = function Worker(url) {\n\tlet messageQueue = [],\n\t\tinside = mitt(),\n\t\toutside = mitt(),\n\t\tscope = {\n\t\t\tonmessage: null,\n\t\t\tdispatchEvent: inside.emit,\n\t\t\taddEventListener: inside.on,\n\t\t\tremoveEventListener: inside.off,\n\t\t\tpostMessage(data) {\n\t\t\t\toutside.emit('message', { data });\n\t\t\t},\n\t\t\tfetch: global.fetch\n\t\t},\n\t\tgetScopeVar;\n\tinside.on('message', e => { let f = getScopeVar('onmessage'); if (f) f.call(scope, e); });\n\tthis.addEventListener = outside.on;\n\tthis.removeEventListener = outside.off;\n\tthis.dispatchEvent = outside.emit;\n\toutside.on('message', e => { this.onmessage && this.onmessage(e); });\n\tthis.postMessage = data => {\n\t\tif (messageQueue!=null) messageQueue.push(data);\n\t\telse inside.emit('message', { data });\n\t};\n\tthis.terminate = () => {\n\t\tthrow Error('Not Supported');\n\t};\n\tglobal.fetch(url)\n\t\t.then( r => r.text() )\n\t\t.then( code => {\n\t\t\tlet vars = 'var self=this,global=self';\n\t\t\tfor (let k in scope) vars += `,${k}=self.${k}`;\n\t\t\t// eval('(function() {'+vars+'\\n'+code+'\\n})').call(scope);\n\t\t\tgetScopeVar = eval('(function() {'+vars+'\\n'+code+'\\nreturn function(__){return eval(__)}})').call(scope);\n\t\t\tlet q = messageQueue;\n\t\t\tmessageQueue = null;\n\t\t\tq.forEach(this.postMessage);\n\t\t})\n\t\t.catch( e => { outside.emit('error', e); console.error(e); });\n};\n"],"names":["global","URL","$$objects","Map","createObjectURL","blob","let","id","uuid","oldFetch","fetch","url","opts","match","Promise","resolve","reject","fr","FileReader","onload","Res","Response","result","status","statusText","onerror","error","readAsText","call","this","Event","type","document","createEvent","Worker","messageQueue","inside","mitt","outside","scope","onmessage","dispatchEvent","emit","addEventListener","on","removeEventListener","off","postMessage","data","getScopeVar","e","f","push","terminate","Error","then","r","text","code","vars","k","eval","q","forEach","catch","console"],"mappings":"0bAKA,GADKA,OAAOC,MAAKD,OAAOC,SACnBD,OAAOC,IAAIC,UAAW,CAC1BF,OAAOC,IAAIC,UAAY,IAAIC,IAC3BH,OAAOC,IAAIG,yBAAkBC,GAC5BC,IAAIC,EAAKC,OAET,OADAR,OAAOC,IAAIC,UAAUK,GAAMF,2BACKE,GAGjCD,IAAIG,SAAWT,OAAOU,OAASA,eAC/BV,OAAOU,MAAQ,SAASC,EAAKC,GAC5B,OAAID,EAAIE,MAAM,UACN,IAAIC,iBAAUC,EAASC,GAC7BV,IAAIW,EAAK,IAAIC,WACbD,EAAGE,kBACFb,IAAIc,EAAMpB,OAAOqB,UAAYA,eAC7BN,EAAQ,IAAIK,EAAIH,EAAGK,QAAUC,OAAQ,IAAKC,WAAY,SAEvDP,EAAGQ,mBACFT,EAAOC,EAAGS,QAEXpB,IAAIC,EAAKI,EAAIE,MAAM,UAAU,GAC7BI,EAAGU,WAAW3B,OAAOC,IAAIC,UAAUK,MAG9BE,SAASmB,KAAKC,KAAMlB,EAAKC,IAQlC,SAASkB,MAAMC,GAAQF,KAAKE,KAAOA,EAJ9B/B,OAAOgC,WACXhC,OAAOgC,aAIHhC,OAAOgC,SAASC,cACpBjC,OAAOgC,SAASC,YAAc,SAASF,GAEtC,OAAO,IADI/B,OAAO+B,IAASD,OACXC,KAKlB/B,OAAOkC,OAAS,SAASA,OAAOvB,qBAC3BwB,gBACHC,OAASC,OACTC,QAAUD,OACVE,OACCC,UAAW,KACXC,cAAeL,OAAOM,KACtBC,iBAAkBP,OAAOQ,GACzBC,oBAAqBT,OAAOU,IAC5BC,qBAAYC,GACXV,QAAQI,KAAK,gBAAaM,KAE3BtC,MAAOV,OAAOU,OAEfuC,YACDb,OAAOQ,GAAG,mBAAWM,GAAO5C,IAAI6C,EAAIF,YAAY,aAAkBE,GAAGA,EAAEvB,KAAKW,MAAOW,KACnFrB,KAAKc,iBAAmBL,QAAQM,GAChCf,KAAKgB,oBAAsBP,QAAQQ,IACnCjB,KAAKY,cAAgBH,QAAQI,KAC7BJ,QAAQM,GAAG,mBAAWM,GAAOrB,OAAKW,WAAaX,OAAKW,UAAUU,KAC9DrB,KAAKkB,qBAAcC,GACA,MAAdb,aAAoBA,aAAaiB,KAAKJ,GACrCZ,OAAOM,KAAK,gBAAaM,KAE/BnB,KAAKwB,qBACJ,MAAMC,MAAM,kBAEbtD,OAAOU,MAAMC,KACX4C,cAAMC,UAAKA,EAAEC,SACbF,cAAMG,MACNpD,IAAIqD,KAAO,4BACX,IAAKrD,IAAIsD,KAAKrB,MAAOoB,MAAQ,IAAIC,WAAUA,EAE3CX,YAAcY,KAAK,gBAAgBF,KAAK,KAAKD,KAAK,4CAA4C9B,KAAKW,OACnGjC,IAAIwD,EAAI3B,aACRA,aAAe,KACf2B,EAAEC,QAAQlC,OAAKkB,eAEfiB,eAAOd,GAAOZ,QAAQI,KAAK,QAASQ,GAAIe,QAAQvC,MAAMwB"}